#!/usr/bin/env bash

# exit on error
set -Eeuo pipefail

# Set secure permissions on created directories and files
umask 077

# Define version and architecture for op
op_email="{{ .email }}"
op_arch="{{ .chezmoi.arch }}"

# Set up colors
red=$(tput setaf 1)
green=$(tput setaf 2)
reset=$(tput sgr0)

verlte() {
    printf '%s\n%s' "$1" "$2" | sort -C -V
}

verlt() {
    ! verlte "$2" "$1"
}

echo "${green}Enabling COPR repositories${reset}"
sudo dnf --quiet copr enable atim/bottom -y &> /dev/null
sudo dnf --quiet copr enable atim/lazygit -y &> /dev/null
sudo dnf --quiet copr enable varlad/zellij -y &> /dev/null

if ! rpm -q puppet-tools-release &> /dev/null; then
    echo "${green}Enabling Puppet repository${reset}"
    sudo rpm -Uvh https://yum.puppet.com/puppet-tools-release-fedora-34.noarch.rpm
fi

echo "${green}Installing dependencies${reset}"
sudo dnf --quiet install -y \
    bottom \
    cargo \
    distrobox \
    exa \
    gh \
    git \
    golang \
    jq \
    lazygit \
    mc \
    neovim \
    nodejs \
    poetry \
    puppet-bolt \
    python3 \
    python3-pip \
    ranger \
    ripgrep \
    zellij

echo "${green}Installing development environment${reset}"
sudo dnf --quiet group install -y "Development Tools" "C Development Tools and Libraries"
sudo dnf --quiet install -y rbenv lua-devel luajit luajit-devel

if [ ! -d "${HOME}/.config/nvim" ]; then
    echo "${green}Cloning AstroNvim${reset}"
    git clone --depth 1 https://github.com/AstroNvim/AstroNvim ~/.config/nvim
elif [ -f "${HOME}/.config/nvim/config.ld" ]; then
    echo "${green}Updating AstroNvim${reset}"
    git -C "${HOME}/.config/nvim" pull --ff-only
fi

echo "${green}Installing LSP/lint/formatters${reset}"
pip install --quiet --no-input --user --upgrade beautysh black isort
if ! command -v puppet-languageserver &>/dev/null; then
    curr_dir="${PWD}"
    dir=$(mktemp -d)
    git clone https://github.com/puppetlabs/puppet-editor-services.git ${dir}
    cd "${dir}"
    if [ "$(rbenv versions --bare --skip-aliases | grep 3.1.2)" != "3.1.2" ]; then
        rbenv install 3.1.2
    fi
    source <(rbenv init - bash)
    rbenv global 3.1.2
    rbenv local 3.1.2
    gem install bundler
    bundle install
    bundle exec rake gem_revendor
    cd "${curr_dir}"
    mv "${dir}" "${HOME}/.local/share/puppet-languageserver"
fi

echo "${green}Installing CI/CD Python tools${reset}"
pip install --quiet --no-input --user --upgrade ggshield pre-commit

# -*-mode:shellscript-*- vim:ft=bash:
